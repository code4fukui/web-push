/*
reqDetail {
  method: 'POST',
  headers: {
    TTL: 2419200,
    'Content-Length': 136,
    'Content-Type': 'application/octet-stream',
    'Content-Encoding': 'aes128gcm',
    Authorization: 'vapid t=eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYzMTI1MSwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.IY6tJ8FfhPmCjYS1nga337DyWNX9Zg7jNM_tgFCsLH8nPa81Z5079BUarwwdqWYDwegBTvb362YBuuAjLad-hg, k=BAnjUlDKJRB5GGE_kVbXlH7WB66cVS_mMGhbDpLwwb8VPYujtgxfrzBcPKlsQr0v2-ckYwy0gIfXUNUWzL451Hs',
    Urgency: 'normal'
  },
    body: <Buffer a0 9a e4 d3 ff 66 c0 35 74 67 59 58 7e 67 b5 e6 00 00 10 00 41 04 88 08 fa d9 9b 33 14 7b cb 52 22 0b 68 89 4a 25 91 d5 a1 d3 ba 49 56 2c 7a fc be 92 ... 86 more bytes>,
  endpoint: 'https://web.push.apple.com/QO2PUyNLSy73dR6fFhwch1X8fRjY_qltGQV2PdEdRbvKp1h5JCuWacOQf0hfssWqcHrXXdL4OKLrpMBvNP2NkAgbNofa5ODVh7FoSltFDPDDibWsnTs5-dkmx5w9KPG70TWwiypliEiO9dnCBFJLiiT1CJ2PWmN_dPtYusTwLSw'
}

reqDetail {
  "method": "POST",
  "headers": {
    "TTL": 2419200,
    "Content-Length": 136,
    "Content-Type": "application/octet-stream",
    "Content-Encoding": "aes128gcm",
    "Authorization": "vapid t=eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYzMDkwNCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.MEUCIQCoVzRqNSUazjeTU3aHpkki8gKAJSnFjTgfwodJXGiDRQIgON2-ydRE3ZM5aDi7C3Dmmi9oxaJmgreRBwqe_Vcmmfc, k=BAnjUlDKJRB5GGE_kVbXlH7WB66cVS_mMGhbDpLwwb8VPYujtgxfrzBcPKlsQr0v2-ckYwy0gIfXUNUWzL451Hs",
    "Urgency": "normal"
  },
  "body": {
    "0": 211,
    "1": 18,
    "2": 10,
    "3": 189,
    "4": 232,
    "5": 143,
    "6": 124,
    "7": 5,
    "8": 81,
    "9": 241,
    "10": 18,
    "11": 114,
    "12": 118,
    "13": 30,
    "14": 45,
    "15": 132,
    "16": 0,
    "17": 0,
    "18": 16,
    "19": 0,
    "20": 65,
    "21": 4,
    "22": 63,
    "23": 215,
    "24": 199,
    "25": 3,
    "26": 212,
    "27": 129,
    "28": 142,
    "29": 215,
    "30": 67,
    "31": 104,
    "32": 214,
    "33": 31,
    "34": 180,
    "35": 106,
    "36": 226,
    "37": 225,
    "38": 175,
    "39": 200,
    "40": 171,
    "41": 216,
    "42": 5,
    "43": 217,
    "44": 93,
    "45": 132,
    "46": 157,
    "47": 132,
    "48": 47,
    "49": 81,
    "50": 22,
    "51": 13,
    "52": 73,
    "53": 41,
    "54": 65,
    "55": 155,
    "56": 196,
    "57": 12,
    "58": 193,
    "59": 13,
    "60": 213,
    "61": 23,
    "62": 167,
    "63": 243,
    "64": 2,
    "65": 26,
    "66": 133,
    "67": 161,
    "68": 19,
    "69": 24,
    "70": 219,
    "71": 218,
    "72": 209,
    "73": 64,
    "74": 130,
    "75": 241,
    "76": 241,
    "77": 193,
    "78": 40,
    "79": 118,
    "80": 199,
    "81": 103,
    "82": 241,
    "83": 217,
    "84": 253,
    "85": 230,
    "86": 205,
    "87": 233,
    "88": 224,
    "89": 133,
    "90": 103,
    "91": 210,
    "92": 6,
    "93": 218,
    "94": 131,
    "95": 29,
    "96": 88,
    "97": 209,
    "98": 191,
    "99": 101,
    "100": 14,
    "101": 36,
    "102": 145,
    "103": 248,
    "104": 154,
    "105": 123,
    "106": 23,
    "107": 106,
    "108": 103,
    "109": 249,
    "110": 30,
    "111": 162,
    "112": 96,
    "113": 254,
    "114": 187,
    "115": 63,
    "116": 59,
    "117": 62,
    "118": 127,
    "119": 213,
    "120": 168,
    "121": 90,
    "122": 162,
    "123": 171,
    "124": 210,
    "125": 209,
    "126": 60,
    "127": 206,
    "128": 173,
    "129": 161,
    "130": 172,
    "131": 163,
    "132": 223,
    "133": 153,
    "134": 122,
    "135": 236
  },
  "endpoint": "https://web.push.apple.com/QO2PUyNLSy73dR6fFhwch1X8fRjY_qltGQV2PdEdRbvKp1h5JCuWacOQf0hfssWqcHrXXdL4OKLrpMBvNP2NkAgbNofa5ODVh7FoSltFDPDDibWsnTs5-dkmx5w9KPG70TWwiypliEiO9dnCBFJLiiT1CJ2PWmN_dPtYusTwLSw"
}
vapid t=eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYzMDkwNCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.MEUCIQCoVzRqNSUazjeTU3aHpkki8gKAJSnFjTgfwodJXGiDRQIgON2-ydRE3ZM5aDi7C3Dmmi9oxaJmgreRBwqe_Vcmmfc, k=BAnjUlDKJRB5GGE_kVbXlH7WB66cVS_mMGhbDpLwwb8VPYujtgxfrzBcPKlsQr0v2-ckYwy0gIfXUNUWzL451Hs

X51ISoXLk1BbNNMUw1UdU1WfjadtOo8QHWilf57Rv2c0xalxYKEuA1RQuXlSa4Lht7MsFRR9M2Ljn5R2TIHUWA
*/
import { Base64URL } from "https://js.sabae.cc/Base64URL.js";
import * as JWS from "./JWS_prime256v1.js";

const publicKey = "BAnjUlDKJRB5GGE_kVbXlH7WB66cVS_mMGhbDpLwwb8VPYujtgxfrzBcPKlsQr0v2-ckYwy0gIfXUNUWzL451Hs";
const privateKey = "XrM3elAzmPJAZuKgbmel2fr-ZIZCMEMhmJHfA5aFZZw";

//const s = "eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYyNDU1Niwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ";
const s = "eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYzMDkwNCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ";
console.log(new TextDecoder().decode(Base64URL.decode(s)));

const header = {
  typ: 'JWT',
  alg: 'ES256'
};
const payload = {
  aud: "https://web.push.apple.com",
  exp: 1703525598,
  sub: "mailto:fukuno@jig.jp",
};

const jwt0 = JWS.sign(header, payload, privateKey);
console.log("sign", jwt0);

console.log(JWS.verify(jwt0, publicKey))

// deno
//const jwt = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYyNDQ2MCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.xtMUJydQKTgJB2ByZjNUoA8DQ0tyQ2evg0FowQsEhKWmsrGYdQ_4yOzwQWwgICSeircyVc1AeGNGOFKZRC5vXw";
//const jwt = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYyNTIwOSwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.MEUCIQCoVzRqNSUazjeTU3aHpkki8gKAJSnFjTgfwodJXGiDRQIgON2-ydRE3ZM5aDi7C3Dmmi9oxaJmgreRBwqe_Vcmmfc";
const jwt = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYzMzg4Nywic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.MEUCIQCoVzRqNSUazjeTU3aHpkki8gKAJSnFjTgfwodJXGiDRQIgON2-ydRE3ZM5aDi7C3Dmmi9oxaJmgreRBwqe_Vcmmfc";
// node
//const jwt = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzYyNDU1Niwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.MEUCIQCoVzRqNSUazjeTU3aHpkki8gKAJSnFjTgfwodJXGiDRQIgON2-ydRE3ZM5aDi7C3Dmmi9oxaJmgreRBwqe_Vcmmfc";
//console.log(JWS.verify(jwt, publicKey));

// node ok! -> but can't verify
const jwt_node1 = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzUyNTU5OCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.X51ISoXLk1BbNNMUw1UdU1WfjadtOo8QHWilf57Rv2c0xalxYKEuA1RQuXlSa4Lht7MsFRR9M2Ljn5R2TIHUWA";
//console.log("jwt_node", JWS.verify(jwt_node1, publicKey))
const jwt_node2 = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzY1MzY5MCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.rZfGJHXEqyj_A4Z6mW4hg9viXMlsu10Ywlykr-v7y0Yw9WwZp4CnTmpt-SOUP1izVd8AcIRgMT-RMcpD4IsSFg";
console.log("jwt_node2", JWS.verify(jwt_node2, publicKey))

// deno ng
const jwt_deno1 = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzUyNTU5OCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.MEUCIQCoVzRqNSUazjeTU3aHpkki8gKAJSnFjTgfwodJXGiDRQIgON2-ydRE3ZM5aDi7C3Dmmi9oxaJmgreRBwqe_Vcmmfc";
//console.log("jwt_deno", JWS.verify(jwt_deno1, publicKey))
const jwt_deno2 = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzUyNTU5OCwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.9_bTBYAPkTx0_PhS4ZZqLJsT9yMPyT1-Thb2klJipnc";
const jwt_deno3 = "eyJ0eXAiOiJKV1QiLCJhbGciOiJFUzI1NiJ9.eyJhdWQiOiJodHRwczovL3dlYi5wdXNoLmFwcGxlLmNvbSIsImV4cCI6MTcwMzY1Mzg2Niwic3ViIjoibWFpbHRvOmZ1a3Vub0BqaWcuanAifQ.qFc0ajUlGs43k1N2h6ZJIvICgCUpxY04H8KHSVxog0U43b7J1ETdkzloOLsLcOaaL2jFomaCt5EHCp79VyaZ9w";
//console.log("jwt_node", JWS.verify(jwt_deno3, publicKey))
